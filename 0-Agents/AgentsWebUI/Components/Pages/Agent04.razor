@page "/agent04"
@inject IConfiguration Configuration
@inject IJSRuntime JsRuntime

<PageTitle>Agent 04</PageTitle>

<h1>Agent 0 - Functions with User Approval</h1>

<p>Features user approval for function calls using ApprovalRequiredAIFunction, prompting confirmations via JavaScript dialog before executing math operations.</p>

<div class="form-group mb-3">
    <label>Instructions</label>
    <InputTextArea @bind-Value="instructions" class="form-control"></InputTextArea>
</div>
<div class="form-group mb-3">
    <label>Message</label>
    <InputTextArea @bind-Value="message" class="form-control"></InputTextArea>
</div>
<div class="form-group mb-3">
    <button type="submit" class="btn btn-primary" disabled="@isLoading" onclick="@OnSubmit">Submit</button>
    <button type="submit" class="btn btn-primary" disabled="@isLoading" onclick="@OnSubmitStream">Stream</button>
</div>

@if (!string.IsNullOrEmpty(response))
{
    <div>
        <div class="mb-3 card">
            <div class="card-body">
                <h5 class="card-title">Response</h5>
                <p class="card-text">@response</p>
            </div>
        </div>
        <div class="mb-3 card">
            <div class="card-body">
                <h5 class="card-title">Log</h5>
                <p class="card-text">@((MarkupString)log)</p>
            </div>
        </div>
    </div>

}

@code {
    @* Suppress MEAI001 for ApprovalRequiredAIFunction usage *@

#pragma warning disable MEAI001

    private string message = "I have purchased an apples for $5. I purchased 10 more apples $4 each.";
    private string instructions = "You are good at math.";
    private string modelName = "openai/gpt-4.1-nano";
    private string endpoint = "https://openrouter.ai/api/v1";
    private ChatClientAgent agent = default!;

    private string response = string.Empty;
    private string log = string.Empty;
    private bool isLoading = false;

    protected override Task OnInitializedAsync()
    {
        var apiKey = Configuration["OPEN_ROUTER_API_KEY"] ??
            throw new InvalidOperationException("OPEN_ROUTER_API_KEY is not set in.");

        var openAIClientOptions = new OpenAIClientOptions
        {
            Endpoint = new Uri(endpoint),
        };

        var credential = new ApiKeyCredential(apiKey);
        var chatClient = new ChatClient(modelName, credential, openAIClientOptions);


        agent = chatClient.CreateAIAgent(instructions: instructions, tools:
            [
                new ApprovalRequiredAIFunction(AIFunctionFactory.Create(Add)),
                new ApprovalRequiredAIFunction(AIFunctionFactory.Create(Multiply))
            ]);

        return base.OnInitializedAsync();
    }

    private async Task OnSubmit()
    {
        response = string.Empty;
        log = "Starting synchronous run...<br />";
        isLoading = true;

        var thread = agent.GetNewThread();
        var agentResponse = await agent.RunAsync(message, thread);
        var userInputRequests = agentResponse.UserInputRequests.ToList();

        while (userInputRequests.Count > 0)
        {
            var userInputResponses = new List<Microsoft.Extensions.AI.ChatMessage>();
            foreach (var functionApprovalRequest in userInputRequests.OfType<FunctionApprovalRequestContent>())
            {
                var confirmMessage = $"Do you want to approve the function call to {functionApprovalRequest.FunctionCall.Name}? ";
                log += $"{confirmMessage}";
                await InvokeAsync(StateHasChanged);
                var confirmed = await FunctionCallConfirm(confirmMessage);
                log += confirmed ? "User approved.<br />" : "User denied.<br />";
                await InvokeAsync(StateHasChanged);
                userInputResponses.Add(new Microsoft.Extensions.AI.ChatMessage(ChatRole.User, [functionApprovalRequest.CreateResponse(confirmed)]));
            }

            agentResponse = await agent.RunAsync(userInputResponses, thread);
            userInputRequests = agentResponse.UserInputRequests.ToList();
        }
        response = agentResponse.ToString();

        isLoading = false;
    }

    private async Task OnSubmitStream()
    {
        response = string.Empty;
        log = "Starting streaming run...<br />";
        isLoading = true;

        var thread = agent.GetNewThread();
        var updates = await agent.RunStreamingAsync(message, thread).ToListAsync();
        var userInputRequests = updates.SelectMany(x => x.UserInputRequests).ToList();

        while (userInputRequests.Count > 0)
        {
            var userInputResponses = new List<Microsoft.Extensions.AI.ChatMessage>();
            foreach (var functionApprovalRequest in userInputRequests.OfType<FunctionApprovalRequestContent>())
            {
                var confirmMessage = $"Do you want to approve the function call to {functionApprovalRequest.FunctionCall.Name}? ";
                log += $"{confirmMessage}";
                await InvokeAsync(StateHasChanged);
                var confirmed = await FunctionCallConfirm(confirmMessage);
                log += confirmed ? "User approved.<br />" : "User denied.<br />";
                await InvokeAsync(StateHasChanged);
                userInputResponses.Add(new Microsoft.Extensions.AI.ChatMessage(ChatRole.User, [functionApprovalRequest.CreateResponse(confirmed)]));
            }

            updates = await agent.RunStreamingAsync(userInputResponses, thread).ToListAsync();
            userInputRequests = updates.SelectMany(x => x.UserInputRequests).ToList();

            foreach (var item in updates)
            {
                response += item.ToString();
                await Task.Delay(100); // Simulate delay for better UX
                await InvokeAsync(StateHasChanged);
            }
        }


        isLoading = false;
    }

    [Description("Add two given numbers.")]
    private float Add([Description("First number")] float a, [Description("Second number")] float b)
    {
        log += $"Adding {a} and {b} <br />";
        return a + b;
    }

    [Description("Multiply two given numbers.")]
    private float Multiply([Description("First number")] float a, [Description("Second number")] float b)
    {
        log += $"Multiplying {a} and {b} <br />";
        return a * b;
    }

    private async Task<bool> FunctionCallConfirm(string message)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", message);
        return confirmed;
    }

#pragma warning restore MEAI001
}
